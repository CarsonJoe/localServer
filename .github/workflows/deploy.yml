name: Deploy to Local Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Debug - Show environment
      run: |
        echo "=== DEBUGGING INFO ==="
        echo "Current directory: $(pwd)"
        echo "GitHub Workspace: $GITHUB_WORKSPACE"
        echo "Contents of current directory:"
        ls -la
        echo ""
        echo "Contents of scripts directory:"
        ls -la scripts/ 2>/dev/null || echo "‚ùå scripts directory not found"
        echo ""
        echo "File permissions for deploy.sh:"
        ls -la scripts/deploy.sh 2>/dev/null || echo "‚ùå deploy.sh not found"
        echo ""
        echo "First few lines of deploy.sh:"
        head -5 scripts/deploy.sh 2>/dev/null || echo "‚ùå Cannot read deploy.sh"
        echo "=== END DEBUG ==="
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Make script executable
      run: |
        echo "Making deploy.sh executable..."
        chmod +x scripts/deploy.sh
        echo "Checking permissions after chmod:"
        ls -la scripts/deploy.sh
    
    - name: Deploy application
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "Running deployment script..."
        ./scripts/deploy.sh
    
    - name: Wait for service to start
      run: sleep 15
    
    - name: Health check
      run: |
        curl -f http://localhost:3001/api/sources || (
          echo "‚ùå Health check failed"
          sudo systemctl status research-repo
          sudo journalctl -u research-repo --no-pager -n 20
          exit 1
        )
    
    - name: Deployment success
      run: |
        echo "üéâ Deployment successful!"
        echo "üåê Access your app at: http://$(hostname -I | awk '{print $1}')"